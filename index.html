<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Termo de Responsabilidade – Abertura de Porta Externa</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background-image:url('https://i.postimg.cc/wT3r1R62/papel-timbrado-jpg.jpg');background-repeat:no-repeat;background-size:cover;background-position:top center;margin:0;padding-top:60px;display:flex;justify-content:center}
    .container{width:90%;max-width:820px;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.08)}
    h1{color:#003366;text-align:center;margin:6px 0 14px}
    .term-text{white-space:pre-wrap;background:#f9f9f9;border:1px solid #ddd;padding:12px;border-radius:6px;margin-bottom:16px;max-height:220px;overflow:auto}
    label{display:block;margin-top:12px;font-weight:700}
    input[type="text"], input[type="date"], textarea{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
    .radio-group{margin-top:8px}
    .radio-group label{font-weight:normal;margin-right:16px}
    .ip-group{border:1px solid #ddd;padding:12px;border-radius:6px;background:#fbfbfb;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .small{width:48%}
    button{margin-top:14px;padding:10px 16px;background:#003366;color:#fff;border:0;border-radius:6px;cursor:pointer;font-size:15px}
    button.secondary{background:#6c757d}
    .sig-area{margin-top:12px;border:1px solid #ccc;border-radius:6px;padding:8px;background:#fff}
    canvas{border:1px solid #bbb;border-radius:4px;display:block;width:100%;height:160px;touch-action: none}
    .sig-actions{display:flex;gap:8px;margin-top:8px}
    .note{font-size:13px;color:#444;margin-top:8px}
    @media(max-width:560px){ .small{width:100%} canvas{height:140px} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Termo de Responsabilidade – Abertura de Porta Externa</h1>

    <div class="term-text">
Prezados(as) Clientes,

A Canaã Telecom oferece, por padrão, uma camada adicional de segurança à sua conexão por meio de nosso firewall, que protege sua rede contra ameaças externas e contribui para a estabilidade da sua internet.

No entanto, conforme sua solicitação para a abertura de uma porta externa visando acesso remoto, é fundamental que você esteja ciente dos riscos envolvidos ao alterar essa proteção.

Riscos associados à abertura de porta externa:
- Exposição a ataques cibernéticos
- Roubo de informações sensíveis
- Instabilidade da conexão
- Infecção por vírus e malware
- Uso indevido da sua rede

Recomendação da Canaã Telecom:
Recomendamos a instalação de medidas internas de segurança como senhas fortes, autenticação em duas etapas e restrição de IPs.

Declaro estar ciente dos riscos mencionados acima e solicito, sob minha responsabilidade, a abertura de porta externa na minha rede.
    </div>

    <form id="formulario">
      <label for="nome">Nome completo:</label>
      <input type="text" id="nome" name="nome_completo" required />

      <label for="cpf_cnpj">CPF ou CNPJ:</label>
      <input type="text" id="cpf_cnpj" name="cpf_cnpj" required />

      <label>Deseja acesso ao roteador?:</label>
      <div class="radio-group">
        <label><input type="radio" name="acesso_roteador" value="SIM" required /> SIM</label>
        <label><input type="radio" name="acesso_roteador" value="NÃO" /> NÃO</label>
      </div>

      <div id="ip-container">
        <div class="ip-group" data-index="1">
          <label for="ip_ports_1">Endereço IP e Portas:</label>
          <input type="text" id="ip_ports_1" name="ip_ports_1" required />

          <label for="finalidade_1">Finalidade da abertura:</label>
          <input type="text" id="finalidade_1" name="finalidade_1" required />
        </div>
      </div>

      <button type="button" id="add-ip">Adicionar outro IP</button>

      <label>Protocolo:</label>
      <div class="radio-group">
        <label><input type="radio" name="protocolo" value="TCP" required /> TCP</label>
        <label><input type="radio" name="protocolo" value="UDP" /> UDP</label>
        <label><input type="radio" name="protocolo" value="Ambos" /> Ambos</label>
      </div>

      <div class="row">
        <div class="small">
          <label for="data">Data:</label>
          <input type="date" id="data" name="data" required />
        </div>
        <div class="small">
          <label for="assinatura">Assinatura (nome completo):</label>
          <input type="text" id="assinatura" name="assinatura" required />
        </div>
      </div>

      <!-- Assinatura desenhada obrigatória -->
      <label>Assinatura (desenhe com dedo ou mouse) — obrigatória:</label>
      <div class="sig-area">
        <canvas id="signature-pad"></canvas>
        <div class="sig-actions">
          <button type="button" id="clear-sign" class="secondary">Limpar assinatura</button>
          <button type="button" id="download-sign" class="secondary">Baixar assinatura</button>
          <button type="button" id="govbr" class="secondary">Assinar com Gov.br</button>
        </div>
        <div class="note">A assinatura desenhada é obrigatória. Você também pode usar "Assinar com Gov.br" para autenticar (abre o portal gov.br).</div>
      </div>

      <button type="submit" id="send-btn">Enviar solicitação</button>
    </form>
  </div>

  <script>
  // ----------------------
  // Funções utilitárias
  // ----------------------
  const RECIPIENT = "analise.n2@canaatelecom.com.br";

  function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  }

  // ----------------------
  // Signature Pad (simples)
  // ----------------------
  (function() {
    const canvas = document.getElementById('signature-pad');
    const ctx = canvas.getContext('2d');

    // configura tamanho responsivo do canvas
    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const width = canvas.clientWidth;
      const height = 160;
      canvas.width = Math.floor(width * ratio);
      canvas.height = Math.floor(height * ratio);
      canvas.style.height = height + 'px';
      ctx.scale(ratio, ratio);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.lineWidth = 2.5;
      redrawBackground();
    }

    function redrawBackground(){
      // limpa mantendo transparente
    }

    let drawing=false;
    let lastX=0, lastY=0;

    function pointerDown(e){
      e.preventDefault();
      drawing=true;
      const pt = getPoint(e);
      lastX = pt.x; lastY = pt.y;
    }
    function pointerMove(e){
      if(!drawing) return;
      e.preventDefault();
      const pt = getPoint(e);
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(pt.x, pt.y);
      ctx.stroke();
      lastX = pt.x; lastY = pt.y;
    }
    function pointerUp(e){
      drawing=false;
    }

    function getPoint(e){
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if(e.touches && e.touches[0]){
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    // limpa
    function clearPad(){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // verifica se está em branco
    function isPadEmpty(){
      const blank = document.createElement('canvas');
      blank.width = canvas.width;
      blank.height = canvas.height;
      return canvas.toDataURL() === blank.toDataURL();
    }

    // download
    function downloadPad(){
      if(isPadEmpty()){
        alert('Assinatura vazia — assine antes de baixar.');
        return;
      }
      const data = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = data;
      a.download = 'assinatura.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // eventos
    canvas.addEventListener('pointerdown', pointerDown);
    canvas.addEventListener('pointermove', pointerMove);
    canvas.addEventListener('pointerup', pointerUp);
    canvas.addEventListener('pointerleave', pointerUp);
    // tocar (mobile)
    canvas.addEventListener('touchstart', pointerDown, {passive:false});
    canvas.addEventListener('touchmove', pointerMove, {passive:false});
    canvas.addEventListener('touchend', pointerUp);

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    document.getElementById('clear-sign').addEventListener('click', clearPad);
    document.getElementById('download-sign').addEventListener('click', downloadPad);

    // botão gov.br - abre portal gov.br (integração real exige backend/API)
    document.getElementById('govbr').addEventListener('click', function(){
      window.open('https://www.gov.br/', '_blank');
    });

    // expose some functions to outer scope
    window._sig = {
      canvas,
      isEmpty: isPadEmpty,
      toDataURL: function(){ return canvas.toDataURL('image/png'); }
    };
  })();

  // ----------------------
  // Adicionar blocos IP
  // ----------------------
  document.getElementById('add-ip').addEventListener('click', () => {
    const container = document.getElementById('ip-container');
    const index = container.querySelectorAll('.ip-group').length + 1;
    const div = document.createElement('div');
    div.className = 'ip-group';
    div.setAttribute('data-index', index);
    div.innerHTML = `
      <label for="ip_ports_${index}">Endereço IP e Portas:</label>
      <input type="text" id="ip_ports_${index}" name="ip_ports_${index}" required />
      <label for="finalidade_${index}">Finalidade da abertura:</label>
      <input type="text" id="finalidade_${index}" name="finalidade_${index}" required />
    `;
    container.appendChild(div);
  });

  // ----------------------
  // Envio do formulário
  // ----------------------
  document.getElementById('formulario').addEventListener('submit', function(e){
    e.preventDefault();

    // valida assinatura desenhada (obrigatória)
    if(window._sig.isEmpty()){
      alert('Assinatura desenhada é obrigatória. Por favor, assine no campo.');
      return;
    }

    // coleta campos
    const nome = document.getElementById('nome').value.trim();
    const cpf = document.getElementById('cpf_cnpj').value.trim();
    const acesso = document.querySelector('input[name="acesso_roteador"]:checked')?.value || '';
    const protocolo = document.querySelector('input[name="protocolo"]:checked')?.value || '';
    const data = document.getElementById('data').value;
    const assinaturaNome = document.getElementById('assinatura').value.trim();

    // monta ips
    let ipsText = '';
    document.querySelectorAll('.ip-group').forEach((g, idx) => {
      const i = idx+1;
      const ipv = g.querySelector(`[name="ip_ports_${i}"]`)?.value?.trim() || '';
      const fin = g.querySelector(`[name="finalidade_${i}"]`)?.value?.trim() || '';
      if(ipv || fin) ipsText += `IP ${i}: ${ipv} - Finalidade: ${fin}\n`;
    });

    // assinatura imagem
    const sigDataUrl = window._sig.toDataURL();

    // montando o corpo do email (texto)
    let corpo =
`Nome: ${nome}
CPF/CNPJ: ${cpf}
Acesso ao roteador: ${acesso}
${ipsText}Protocolo: ${protocolo}
Data: ${data}
Assinatura (nome): ${assinaturaNome}
`;
    // tentativa de incluir imagem: se pequena, incluir base64 diretamente; se grande, avisar e abrir imagem em nova aba para download/atach
    const MAX_URL_SAFE = 8000; // valor aproximado para evitar URLs gigantes
    if(sigDataUrl.length < MAX_URL_SAFE){
      corpo += '\nAssinatura (imagem Base64 PNG):\n' + sigDataUrl;
      // nesta situação, a base64 é incorporada no corpo (nem sempre ideal, mas funciona como registro)
    } else {
      // arquivo muito grande para URL — abrir em nova aba para que o usuário anexe manualmente
      corpo += '\nAssinatura: (imagem muito grande para incorporar automaticamente). Ao abrir a nova aba, salve a imagem e anexe ao e-mail antes de enviar.\n';
    }

    const assunto = 'Solicitação de Abertura de Porta Externa';
    const subjectEnc = encodeURIComponent(assunto);
    const bodyEnc = encodeURIComponent(corpo);

    // URLs para app/web/mailto
    const webGmail = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(RECIPIENT)}&su=${subjectEnc}&body=${bodyEnc}`;
    const gmailApp = `googlegmail://co?to=${encodeURIComponent(RECIPIENT)}&subject=${subjectEnc}&body=${bodyEnc}`;
    const mailto = `mailto:${encodeURIComponent(RECIPIENT)}?subject=${subjectEnc}&body=${bodyEnc}`;

    // se assinatura muito grande, mostrar a imagem em nova aba para o usuário salvar (ajuda a anexar)
    if(sigDataUrl.length >= MAX_URL_SAFE){
      window.open(sigDataUrl, '_blank'); // mostra imagem para download manual
    }

    // abre compose: app Gmail (mobile) -> webGmail -> mailto fallback
    if(isMobile()){
      // tenta app gmail, depois web, depois mailto
      window.location.href = gmailApp;
      setTimeout(()=> window.location.href = webGmail, 600);
      setTimeout(()=> window.location.href = mailto, 2000);
    } else {
      // desktop: abrir nova aba com Gmail web compose
      window.open(webGmail, '_blank');
    }

  }); // end submit
  </script>
</body>
</html>
